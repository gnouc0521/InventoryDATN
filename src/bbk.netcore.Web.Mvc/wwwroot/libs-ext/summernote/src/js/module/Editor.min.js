/**
 * Minified by jsDelivr using Terser v5.9.0.
 * Original file: /npm/summernote@0.8.20/src/js/module/Editor.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import $ from"jquery";import env from"../core/env";import key from"../core/key";import func from"../core/func";import lists from"../core/lists";import dom from"../core/dom";import range from"../core/range";import{readFileAsDataURL,createImage}from"../core/async";import History from"../editing/History";import Style from"../editing/Style";import Typing from"../editing/Typing";import Table from"../editing/Table";import Bullet from"../editing/Bullet";const KEY_BOGUS="bogus";export default class Editor{constructor(t){this.context=t,this.$note=t.layoutInfo.note,this.$editor=t.layoutInfo.editor,this.$editable=t.layoutInfo.editable,this.options=t.options,this.lang=this.options.langInfo,this.editable=this.$editable[0],this.lastRange=null,this.snapshot=null,this.style=new Style,this.table=new Table,this.typing=new Typing(t),this.bullet=new Bullet,this.history=new History(t),this.context.memo("help.escape",this.lang.help.escape),this.context.memo("help.undo",this.lang.help.undo),this.context.memo("help.redo",this.lang.help.redo),this.context.memo("help.tab",this.lang.help.tab),this.context.memo("help.untab",this.lang.help.untab),this.context.memo("help.insertParagraph",this.lang.help.insertParagraph),this.context.memo("help.insertOrderedList",this.lang.help.insertOrderedList),this.context.memo("help.insertUnorderedList",this.lang.help.insertUnorderedList),this.context.memo("help.indent",this.lang.help.indent),this.context.memo("help.outdent",this.lang.help.outdent),this.context.memo("help.formatPara",this.lang.help.formatPara),this.context.memo("help.insertHorizontalRule",this.lang.help.insertHorizontalRule),this.context.memo("help.fontName",this.lang.help.fontName);const e=["bold","italic","underline","strikethrough","superscript","subscript","justifyLeft","justifyCenter","justifyRight","justifyFull","formatBlock","removeFormat","backColor"];for(let t=0,s=e.length;t<s;t++)this[e[t]]=(t=>e=>{this.beforeCommand(),document.execCommand(t,!1,e),this.afterCommand(!0)})(e[t]),this.context.memo("help."+e[t],this.lang.help[e[t]]);this.fontName=this.wrapCommand((t=>this.fontStyling("font-family",env.validFontName(t)))),this.fontSize=this.wrapCommand((t=>{const e=this.currentStyle()["font-size-unit"];return this.fontStyling("font-size",t+e)})),this.fontSizeUnit=this.wrapCommand((t=>{const e=this.currentStyle()["font-size"];return this.fontStyling("font-size",e+t)}));for(let t=1;t<=6;t++)this["formatH"+t]=(t=>()=>{this.formatBlock("H"+t)})(t),this.context.memo("help.formatH"+t,this.lang.help["formatH"+t]);this.insertParagraph=this.wrapCommand((()=>{this.typing.insertParagraph(this.editable)})),this.insertOrderedList=this.wrapCommand((()=>{this.bullet.insertOrderedList(this.editable)})),this.insertUnorderedList=this.wrapCommand((()=>{this.bullet.insertUnorderedList(this.editable)})),this.indent=this.wrapCommand((()=>{this.bullet.indent(this.editable)})),this.outdent=this.wrapCommand((()=>{this.bullet.outdent(this.editable)})),this.insertNode=this.wrapCommand((t=>{if(this.isLimited($(t).text().length))return;this.getLastRange().insertNode(t),this.setLastRange(range.createFromNodeAfter(t).select())})),this.insertText=this.wrapCommand((t=>{if(this.isLimited(t.length))return;const e=this.getLastRange().insertNode(dom.createText(t));this.setLastRange(range.create(e,dom.nodeLength(e)).select())})),this.pasteHTML=this.wrapCommand((t=>{if(this.isLimited(t.length))return;t=this.context.invoke("codeview.purify",t);const e=this.getLastRange().pasteHTML(t);this.setLastRange(range.createFromNodeAfter(lists.last(e)).select())})),this.formatBlock=this.wrapCommand(((t,e)=>{const s=this.options.callbacks.onApplyCustomStyle;s?s.call(this,e,this.context,this.onFormatBlock):this.onFormatBlock(t,e)})),this.insertHorizontalRule=this.wrapCommand((()=>{const t=this.getLastRange().insertNode(dom.create("HR"));t.nextSibling&&this.setLastRange(range.create(t.nextSibling,0).normalize().select())})),this.lineHeight=this.wrapCommand((t=>{this.style.stylePara(this.getLastRange(),{lineHeight:t})})),this.createLink=this.wrapCommand((t=>{let e=t.url;const s=t.text,i=t.isNewWindow,o=t.checkProtocol;let n=t.range||this.getLastRange();const a=s.length-n.toString().length;if(a>0&&this.isLimited(a))return;const r=n.toString()!==s;"string"==typeof e&&(e=e.trim()),this.options.onCreateLink?e=this.options.onCreateLink(e):o&&(e=/^([A-Za-z][A-Za-z0-9+-.]*\:|#|\/)/.test(e)?e:this.options.defaultProtocol+e);let h=[];if(r){n=n.deleteContents();const t=n.insertNode($("<A>"+s+"</A>")[0]);h.push(t)}else h=this.style.styleNodes(n,{nodeName:"A",expandClosestSibling:!0,onlyPartialContains:!0});$.each(h,((t,s)=>{$(s).attr("href",e),i?$(s).attr("target","_blank"):$(s).removeAttr("target")})),this.setLastRange(this.createRangeFromList(h).select())})),this.color=this.wrapCommand((t=>{const e=t.foreColor,s=t.backColor;e&&document.execCommand("foreColor",!1,e),s&&document.execCommand("backColor",!1,s)})),this.foreColor=this.wrapCommand((t=>{document.execCommand("foreColor",!1,t)})),this.insertTable=this.wrapCommand((t=>{const e=t.split("x");this.getLastRange().deleteContents().insertNode(this.table.createTable(e[0],e[1],this.options))})),this.removeMedia=this.wrapCommand((()=>{let t=$(this.restoreTarget()).parent();t.closest("figure").length?t.closest("figure").remove():t=$(this.restoreTarget()).detach(),this.context.triggerEvent("media.delete",t,this.$editable)})),this.floatMe=this.wrapCommand((t=>{const e=$(this.restoreTarget());e.toggleClass("note-float-left","left"===t),e.toggleClass("note-float-right","right"===t),e.css("float","none"===t?"":t)})),this.resize=this.wrapCommand((t=>{const e=$(this.restoreTarget());0===(t=parseFloat(t))?e.css("width",""):e.css({width:100*t+"%",height:""})}))}initialize(){this.$editable.on("keydown",(t=>{if(t.keyCode===key.code.ENTER&&this.context.triggerEvent("enter",t),this.context.triggerEvent("keydown",t),this.snapshot=this.history.makeSnapshot(),this.hasKeyShortCut=!1,t.isDefaultPrevented()||(this.options.shortcuts?this.hasKeyShortCut=this.handleKeyMap(t):this.preventDefaultEditableShortCuts(t)),this.isLimited(1,t)){const t=this.getLastRange();if(t.eo-t.so==0)return!1}this.setLastRange(),this.options.recordEveryKeystroke&&!1===this.hasKeyShortCut&&this.history.recordUndo()})).on("keyup",(t=>{this.setLastRange(),this.context.triggerEvent("keyup",t)})).on("focus",(t=>{this.setLastRange(),this.context.triggerEvent("focus",t)})).on("blur",(t=>{this.context.triggerEvent("blur",t)})).on("mousedown",(t=>{this.context.triggerEvent("mousedown",t)})).on("mouseup",(t=>{this.setLastRange(),this.history.recordUndo(),this.context.triggerEvent("mouseup",t)})).on("scroll",(t=>{this.context.triggerEvent("scroll",t)})).on("paste",(t=>{this.setLastRange(),this.context.triggerEvent("paste",t)})).on("input",(()=>{this.isLimited(0)&&this.snapshot&&this.history.applySnapshot(this.snapshot)})),this.$editable.attr("spellcheck",this.options.spellCheck),this.$editable.attr("autocorrect",this.options.spellCheck),this.options.disableGrammar&&this.$editable.attr("data-gramm",!1),this.$editable.html(dom.html(this.$note)||dom.emptyPara),this.$editable.on(env.inputEventName,func.debounce((()=>{this.context.triggerEvent("change",this.$editable.html(),this.$editable)}),10)),this.$editable.on("focusin",(t=>{this.context.triggerEvent("focusin",t)})).on("focusout",(t=>{this.context.triggerEvent("focusout",t)})),this.options.airMode?this.options.overrideContextMenu&&this.$editor.on("contextmenu",(t=>(this.context.triggerEvent("contextmenu",t),!1))):(this.options.width&&this.$editor.outerWidth(this.options.width),this.options.height&&this.$editable.outerHeight(this.options.height),this.options.maxHeight&&this.$editable.css("max-height",this.options.maxHeight),this.options.minHeight&&this.$editable.css("min-height",this.options.minHeight)),this.history.recordUndo(),this.setLastRange()}destroy(){this.$editable.off()}handleKeyMap(t){const e=this.options.keyMap[env.isMac?"mac":"pc"],s=[];t.metaKey&&s.push("CMD"),t.ctrlKey&&!t.altKey&&s.push("CTRL"),t.shiftKey&&s.push("SHIFT");const i=key.nameFromCode[t.keyCode];i&&s.push(i);const o=e[s.join("+")];if("TAB"!==i||this.options.tabDisable)if(o){if(!1!==this.context.invoke(o))return t.preventDefault(),!0}else key.isEdit(t.keyCode)&&this.afterCommand();else this.afterCommand();return!1}preventDefaultEditableShortCuts(t){(t.ctrlKey||t.metaKey)&&lists.contains([66,73,85],t.keyCode)&&t.preventDefault()}isLimited(t,e){return t=t||0,(void 0===e||!(key.isMove(e.keyCode)||key.isNavigation(e.keyCode)||e.ctrlKey||e.metaKey||lists.contains([key.code.BACKSPACE,key.code.DELETE],e.keyCode)))&&(this.options.maxTextLength>0&&this.$editable.text().length+t>this.options.maxTextLength)}createRange(){return this.focus(),this.setLastRange(),this.getLastRange()}createRangeFromList(t){const e=range.createFromNodeBefore(lists.head(t)).getStartPoint(),s=range.createFromNodeAfter(lists.last(t)).getEndPoint();return range.create(e.node,e.offset,s.node,s.offset)}setLastRange(t){t?this.lastRange=t:(this.lastRange=range.create(this.editable),0===$(this.lastRange.sc).closest(".note-editable").length&&(this.lastRange=range.createFromBodyElement(this.editable)))}getLastRange(){return this.lastRange||this.setLastRange(),this.lastRange}saveRange(t){t&&this.getLastRange().collapse().select()}restoreRange(){this.lastRange&&(this.lastRange.select(),this.focus())}saveTarget(t){this.$editable.data("target",t)}clearTarget(){this.$editable.removeData("target")}restoreTarget(){return this.$editable.data("target")}currentStyle(){let t=range.create();return t&&(t=t.normalize()),t?this.style.current(t):this.style.fromNode(this.$editable)}styleFromNode(t){return this.style.fromNode(t)}undo(){this.context.triggerEvent("before.command",this.$editable.html()),this.history.undo(),this.context.triggerEvent("change",this.$editable.html(),this.$editable)}commit(){this.context.triggerEvent("before.command",this.$editable.html()),this.history.commit(),this.context.triggerEvent("change",this.$editable.html(),this.$editable)}redo(){this.context.triggerEvent("before.command",this.$editable.html()),this.history.redo(),this.context.triggerEvent("change",this.$editable.html(),this.$editable)}beforeCommand(){this.context.triggerEvent("before.command",this.$editable.html()),document.execCommand("styleWithCSS",!1,this.options.styleWithCSS),this.focus()}afterCommand(t){this.normalizeContent(),this.history.recordUndo(),t||this.context.triggerEvent("change",this.$editable.html(),this.$editable)}tab(){const t=this.getLastRange();if(t.isCollapsed()&&t.isOnCell())this.table.tab(t);else{if(0===this.options.tabSize)return!1;this.isLimited(this.options.tabSize)||(this.beforeCommand(),this.typing.insertTab(t,this.options.tabSize),this.afterCommand())}}untab(){const t=this.getLastRange();if(t.isCollapsed()&&t.isOnCell())this.table.tab(t,!0);else if(0===this.options.tabSize)return!1}wrapCommand(t){return function(){this.beforeCommand(),t.apply(this,arguments),this.afterCommand()}}insertImage(t,e){return createImage(t,e).then((t=>{this.beforeCommand(),"function"==typeof e?e(t):("string"==typeof e&&t.attr("data-filename",e),t.css("width",Math.min(this.$editable.width(),t.width()))),t.show(),this.getLastRange().insertNode(t[0]),this.setLastRange(range.createFromNodeAfter(t[0]).select()),this.afterCommand()})).fail((t=>{this.context.triggerEvent("image.upload.error",t)}))}insertImagesAsDataURL(t){$.each(t,((t,e)=>{const s=e.name;this.options.maximumImageFileSize&&this.options.maximumImageFileSize<e.size?this.context.triggerEvent("image.upload.error",this.lang.image.maximumFileSizeError):readFileAsDataURL(e).then((t=>this.insertImage(t,s))).fail((()=>{this.context.triggerEvent("image.upload.error")}))}))}insertImagesOrCallback(t){this.options.callbacks.onImageUpload?this.context.triggerEvent("image.upload",t):this.insertImagesAsDataURL(t)}getSelectedText(){let t=this.getLastRange();return t.isOnAnchor()&&(t=range.createFromNode(dom.ancestor(t.sc,dom.isAnchor))),t.toString()}onFormatBlock(t,e){if(document.execCommand("FormatBlock",!1,env.isMSIE?"<"+t+">":t),e&&e.length&&(e[0].tagName.toUpperCase()!==t.toUpperCase()&&(e=e.find(t)),e&&e.length)){const s=this.createRange(),i=$([s.sc,s.ec]).closest(t);i.removeClass();const o=e[0].className||"";o&&i.addClass(o)}}formatPara(){this.formatBlock("P")}fontStyling(t,e){const s=this.getLastRange();if(""!==s){const i=this.style.styleNodes(s);if(this.$editor.find(".note-status-output").html(""),$(i).css(t,e),s.isCollapsed()){const t=lists.head(i);t&&!dom.nodeLength(t)&&(t.innerHTML=dom.ZERO_WIDTH_NBSP_CHAR,range.createFromNode(t.firstChild).select(),this.setLastRange(),this.$editable.data("bogus",t))}else this.setLastRange(this.createRangeFromList(i).select())}else{const t=$.now();this.$editor.find(".note-status-output").html('<div id="note-status-output-'+t+'" class="alert alert-info">'+this.lang.output.noSelection+"</div>"),setTimeout((function(){$("#note-status-output-"+t).remove()}),5e3)}}unlink(){let t=this.getLastRange();if(t.isOnAnchor()){const e=dom.ancestor(t.sc,dom.isAnchor);t=range.createFromNode(e),t.select(),this.setLastRange(),this.beforeCommand(),document.execCommand("unlink"),this.afterCommand()}}getLinkInfo(){const t=this.getLastRange().expand(dom.isAnchor),e=$(lists.head(t.nodes(dom.isAnchor))),s={range:t,text:t.toString(),url:e.length?e.attr("href"):""};return e.length&&(s.isNewWindow="_blank"===e.attr("target")),s}addRow(t){const e=this.getLastRange(this.$editable);e.isCollapsed()&&e.isOnCell()&&(this.beforeCommand(),this.table.addRow(e,t),this.afterCommand())}addCol(t){const e=this.getLastRange(this.$editable);e.isCollapsed()&&e.isOnCell()&&(this.beforeCommand(),this.table.addCol(e,t),this.afterCommand())}deleteRow(){const t=this.getLastRange(this.$editable);t.isCollapsed()&&t.isOnCell()&&(this.beforeCommand(),this.table.deleteRow(t),this.afterCommand())}deleteCol(){const t=this.getLastRange(this.$editable);t.isCollapsed()&&t.isOnCell()&&(this.beforeCommand(),this.table.deleteCol(t),this.afterCommand())}deleteTable(){const t=this.getLastRange(this.$editable);t.isCollapsed()&&t.isOnCell()&&(this.beforeCommand(),this.table.deleteTable(t),this.afterCommand())}resizeTo(t,e,s){let i;if(s){const s=t.y/t.x,o=e.data("ratio");i={width:o>s?t.x:t.y/o,height:o>s?t.x*o:t.y}}else i={width:t.x,height:t.y};e.css(i)}hasFocus(){return this.$editable.is(":focus")}focus(){this.hasFocus()||this.$editable.focus()}isEmpty(){return dom.isEmpty(this.$editable[0])||dom.emptyPara===this.$editable.html()}empty(){this.context.invoke("code",dom.emptyPara)}normalizeContent(){this.$editable[0].normalize()}}
//# sourceMappingURL=/sm/dd7da588feac063faeb39ba37fa84127e2ab89a251b74d566996b5d279dd6d73.map