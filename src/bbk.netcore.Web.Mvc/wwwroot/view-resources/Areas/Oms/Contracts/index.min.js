(function(){function c(){h.ajax.reload()}function r(){i.ajax.reload()}var l=$("#QuoteSynTable"),u=$("#QuoteSynTableApprove"),f=$("#ContractTable"),a=abp.services.app.quotesService,n=abp.services.app.contract,e=abp.services.app.quotesSynthesise,i,t;moment.locale(abp.localization.currentLanguage.name);var o=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/Contract/CreateContract",scriptUrl:abp.appPath+"view-resources/Areas/Oms/Contracts/_CreateModal.js",modalClass:"ContractsCreateModal",modalType:"modal-xl"}),v=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/Contract/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/Oms/Contracts/_CreateModalReject.js",modalClass:"CreateRejectModal",modalType:"modal-xl"}),s=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/Contract/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/Oms/Contracts/_CreateModalContractReject.js",modalClass:"CreateRejectModal",modalType:"modal-xl"}),y=function(){let n={};return n.searchTerm=$("#SearchTerm").val().trim(),n},h=u.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!0,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi",zeroRecords:"Không tìm thấy dữ liệu",searchPlaceholder:"Tìm kiếm"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:e.getAllQuoteApprove},order:[[0,"asc"]],columnDefs:[{orderable:!1,targets:0,width:"5%",render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,data:"code",width:"10%",render:function(n,t,i){return`<div class=''> 
                                <a class='doceditfunc' data-objid='`+i.id+`'href='javascript:void(0); ' > `+i.code+` </a>
                            </div>`}},{orderable:!1,targets:2,data:null,width:"20%",render:function(n,t,i){for(var u="",r=0;r<i.suppliersNames.length;r++)u+=`<span>`+i.suppliersNames[r]+`</span><br>`;return u}},{targets:3,width:"10%",orderable:!1,autoWidth:!1,data:"creationTime",render:function(n){return moment(n).format("L")}},{targets:4,width:"10%",orderable:!1,autoWidth:!1,data:"quoteSynthesiseDate",render:function(n){return moment(n).format("L")}},{targets:5,width:"20%",data:"status",orderable:!1,className:"align-middle text-center",autoWidth:!1,render:()=>`<span class="span_status span-approve"> Đã phê duyệt </span>`},{orderable:!1,targets:6,width:"15%",data:null,className:"text-center",render:function(n,t,i){return`
                            <button class="btn btn-primary btn-create" data-objid="`+i.id+`">Tạo hợp đồng</button>
                           `}}]});abp.event.on("app.reloadgetDocApprove",function(){c()});$("#QuoteSynTableApprove").on("click",".doceditfunc",function(){var n=$(this),t={id:n[0].dataset.objid};abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/Items/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/Quote/CompareDetail?SynthesiseId="+n.id}})});$("#QuoteSynTableApprove").on("click",".btn-create",function(){var n=$(this),t={Id:n[0].dataset.objid};o.open(t)});i=f.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!0,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi",zeroRecords:"Không tìm thấy dữ liệu",searchPlaceholder:"Tìm kiếm"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:n.getAll},order:[[0,"asc"]],columnDefs:[{orderable:!1,targets:0,width:"5%",render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,width:"10%",data:"code",render:function(n,t,i){return`<div class=''> 
                                <a class='doceditfunc' data-objid='`+i.id+`' data-view="`+i.id+`" href='javascript:void(0); ' > `+i.code+` </a>
                            </div>`}},{orderable:!1,targets:2,width:"15%",data:"quoteSynCode"},{orderable:!1,targets:3,width:"15%",data:"supplierName"},{targets:4,width:"15%",orderable:!1,autoWidth:!1,data:"creationTime",render:function(n){return moment(n).format("L")}},{orderable:!1,targets:5,width:"15%",className:"text-center",render:function(n,t,i){return`<span class="total" data-contact="`+i.id+`" data-sup="`+i.supplierId+`" data-quoSyn="`+i.quoteSynId+`"></span>
                            <span class="viewtotal`+i.id+`"></span>`}},{targets:6,data:"status",width:"20%",orderable:!1,autoWidth:!1,className:"align-middle text-center",render:function(n){return n==0?`<span class="span_status span-defaut"> Bản nháp </span>`:n==1?`<span class="span_status span-defaut"> Chờ xử lý </span>`:n==2?`<span class="span_status span-subcontract"> Chờ Phê duyệt </span>`:n==3||n==4?`<span class="span_status span-reject"> Từ chối</span>`:n==5?`<span class="span_status span-approve"> Đã duyệt </span>`:n==6?`<span class="span_status span-approve"> Đã kí hợp đồng </span>`:void 0}},{orderable:!1,targets:7,data:null,width:"5%",render:function(n,t,i){return i.status==0||i.status==6||i.status==2||i.status==1||i.status==5?`
                            <div class='dropdown d-inline-block'>
                            	<a href='#'' class='btn btn-sm btn-icon btn-outline-primary rounded-circle shadow-0' data-toggle='dropdown' aria-expanded='true' title='More options'>
                            		<i class="fal fa-ellipsis-v"></i>
                            	</a>
                            	<div class='dropdown-menu'>
                            		<a class='dropdown-item view-detail' data-view='`+i.id+`' href='javascript:void(0);'>`+app.localize("Xem chi tiết")+`</a>
                            	</div>
                            </div>`:i.status==3||i.status==4?`
                            <div class='dropdown d-inline-block'>
                            	<a href='#'' class='btn btn-sm btn-icon btn-outline-primary rounded-circle shadow-0' data-toggle='dropdown' aria-expanded='true' title='More options'>
                            		<i class="fal fa-ellipsis-v"></i>
                            	</a>
                            	<div class='dropdown-menu'>
                            		<a class='dropdown-item view-detail' data-view='`+i.id+`' href='javascript:void(0);'>`+app.localize("Xem lý do từ chối")+`</a>
                            	</div>
                            </div>`:void 0}}],initComplete:function(){t()}});$("#ContractTable").on("page.dt",function(){t()});t=function(){var i=$(".total"),t={};$.each(i,function(i,r){console.log(r);t.quoSyn=r.dataset.quosyn;t.Supper=r.dataset.sup;n.totalNumber(t).done(function(n){var t=$.fn.dataTable.render.number(",",",","").display,i=n+n/10;$(r).parent("td").find("span:eq(1)").text(t(i))})})};abp.event.on("app.reloadgetDocContact",function(){r()});$("#ContractTable").on("click",".Approve",function(){var i=$(this);let t={};t.status=1;t.id=i[0].dataset.quotesyn;n.updateExportStatus(t).done(function(){abp.notify.success(app.localize("Phê duyệt Hợp dồng thành công"));r()})});$("#ContractTable").on("click",".Reject",function(){var n=$(this),t={id:n[0].dataset.quotesyn};s.open(t)});$("#ContractTable").on("click",".doceditfunc",function(){var n=$(this),t={id:n.attr("data-view")};abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/Contract/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/Contract/Print?Id="+n.id}})});$("#ContractTable").on("click",".view-detail",function(){var n=$(this),t={id:n.attr("data-view")};abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/Contract/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/Contract/Print?Id="+n.id}})})})(jQuery),function(n){app.modals.ContractsCreateModal=function(){var s=abp.services.app.warehouseTypesService,f=abp.services.app.quotesSynthesise,h=n("#ItemTable"),r=abp.services.app.contract,e=abp.services.app.supplier,i,o=null,t=[],u=[];this.init=function(f){i=f;o=i.getModal().find("form[name=frmCreate]");var s=new Date;n("#Select_sup").select2({width:"100%",dropdownParent:n("#ContractsCreateModal"),placeholder:"Chọn nhà cung cấp",search:!0}).on("select2:select",function(i){var f=i.params.data,o=f.id,s={},h,c,l;if(s.id=o,e.get(s).done(function(t){n("#NameSup").text(t.name);n("#AddressSeller").text(t.adress);n("#CodeSeller").text(t.taxCode);n("#PhoneSeller").text(t.phoneNumber);n("#FaxSeller").text(t.fax)}),n("#TableItemContent").empty(),h=`<table id="ItemTable" class="table table-bordered table-hover table-striped w-100">
                                <thead class="bg-primary-600">
                                    <tr>
                                        <th>STT</th>
                                        <th>Tên hàng hóa</th>
                                        <th>Đơn vị tính</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá/ĐVT</th>
                                        <th class="text-center">Thành tiền</th>
                                    </tr>
                                </thead>
                                 <tfoot>
                                    <tr>
                                        <th colspan="5">Cộng giá trị tiền bảng</th>
                                        <th class="text-right"></th>
                                    </tr>
                                    <tr>
                                        <th colspan="5">Thuế GTGT: 10%</th>
                                        <th class="Tax text-right"></th>
                                    </tr>
                                    <tr>
                                        <th colspan="5">Tổng giá trị Hợp đồng</th>
                                        <th class="TotalLast text-right"></th>
                                    </tr>
                                </tfoot>
                                <tbody></tbody>
                            </table>`,n("#TableItemContent").append(h),c=function(){let t={};return t.supper=o,t.quoSyn=n("#QuotesSynId").val(),t},l=n("#ItemTable").DataTable({paging:!1,serverSide:!1,processing:!0,searching:!1,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:r.allItemInContact,inputFilter:c},order:[[0,"asc"]],columnDefs:[{orderable:!1,targets:0,width:"10%",render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,data:"itemName",width:"30%"},{orderable:!1,targets:2,data:"unitName",width:"10%"},{targets:3,width:"10%",orderable:!1,autoWidth:!1,data:"quantityQuote",render:n.fn.dataTable.render.number(",",",","")},{targets:4,width:"10%",orderable:!1,autoWidth:!1,data:"quotePrice",render:n.fn.dataTable.render.number(",",",","")},{targets:5,width:"20%",className:"text-right",data:"totalNumber",orderable:!1,autoWidth:!1,render:n.fn.dataTable.render.number(",",",","")},],footerCallback:function(){var u=this.api(),f=function(n){return typeof n=="string"?n.replace(/[\$,]/g,"")*1:typeof n=="number"?n:0},t,i,r;pageTotal1=u.column(5,{page:"current"}).data().reduce(function(n,t){return f(n)+f(t)},0);t=n.fn.dataTable.render.number(",",",","").display;n(u.column(5).footer()).html(t(pageTotal1));i=pageTotal1/10;n(".Tax").html(t(i));r=pageTotal1+i;n(".TotalLast").html(t(r));n(".TotalLast").attr("data-tong",r)}}),n("#MouthNumber").empty(),n("#Price").empty(),n("#sellerDate").empty(),n("#Indemnify").empty(),n("#BankName").empty(),n("#STK").empty(),n("#RepresentA").empty(),n("#PositionA").empty(),n("#RepresentB").empty(),n("#PositionB").empty(),u.indexOf(f.id)==-1){n("#MouthNumber").append(`<input type="number" class="inputMouthNumber_`+f.id+`" />`);n("#Price").append(`<input type="number" class="inputPrice_`+f.id+`" />`);n("#Indemnify").append(`<input type="number" class="inputIndemnify_`+f.id+`" />`);n("#sellerDate").append(`<input type="date" class="inputsellerDate_`+f.id+`" />`);n("#BankName").append(`<input type="text" class="inputBankName_`+f.id+`" />`);n("#STK").append(`<input type="text" class="inputSTK_`+f.id+`" />`);n("#RepresentA").append(`<input type="text" class="inputRepA_`+f.id+`" />`);n("#PositionA").append(`<input type="text" class="inputPosiA_`+f.id+`" />`);n("#RepresentB").append(`<input type="text" class="inputRepB_`+f.id+`" />`);n("#PositionB").append(`<input type="text" class="inputPosiB_`+f.id+`" />`);let i={};i.SupplierId=f.id;i.QuoteSynId=n("#QuotesSynId").val();i.Status=0;console.log(l);n(".inputRepA_"+f.id).change(function(){i.RepresentA=n(this).val()});n(".inputPosiA_"+f.id).change(function(){i.PositionA=n(this).val()});n(".inputRepB_"+f.id).change(function(){i.RepresentB=n(this).val()});n(".inputPosiB_"+f.id).change(function(){i.PositionB=n(this).val()});n(".inputMouthNumber_"+f.id).change(function(){i.MouthNumber=n(this).val()});n(".inputPrice_"+f.id).change(function(){i.Price=n(this).val()});n(".inputIndemnify_"+f.id).change(function(){i.Indemnify=n(this).val()});n(".inputsellerDate_"+f.id).change(function(){i.SellerDate=n(this).val()});n(".inputBankName_"+f.id).change(function(){i.BankName=n(this).val()});n(".inputSTK_"+f.id).change(function(){i.Stk=n(this).val()});u.push(f.id);t.push(i)}else n.each(t,function(t,i){if(i.SupplierId==f.id){n("#MouthNumber").append(`<input type="number" class="inputMouthNumber_`+f.id+`" />`);n("#Price").append(`<input type="number" class="inputPrice_`+f.id+`" />`);n("#Indemnify").append(`<input type="number" class="inputIndemnify_`+f.id+`" />`);n("#sellerDate").append(`<input type="date" class="inputsellerDate_`+f.id+`" />`);n("#BankName").append(`<input type="text" class="inputBankName_`+f.id+`" />`);n("#STK").append(`<input type="text" class="inputSTK_`+f.id+`" />`);n("#RepresentA").append(`<input type="text" class="inputRepA_`+f.id+`" />`);n("#PositionA").append(`<input type="text" class="inputPosiA_`+f.id+`" />`);n("#RepresentB").append(`<input type="text" class="inputRepB_`+f.id+`" />`);n("#PositionB").append(`<input type="text" class="inputPosiB_`+f.id+`" />`);n(".inputMouthNumber_"+f.id).val(i.MouthNumber);n(".inputPrice_"+f.id).val(i.Price);n(".inputIndemnify_"+f.id).val(i.Indemnify);n(".inputsellerDate_"+f.id).val(i.SellerDate);n(".inputBankName_"+f.id).val(i.BankName);n(".inputSTK_"+f.id).val(i.Stk);n(".inputRepA_"+f.id).val(i.RepresentA);n(".inputPosiA_"+f.id).val(i.PositionA);n(".inputRepB_"+f.id).val(i.RepresentB);n(".inputPosiB_"+f.id).val(i.PositionB);i.SupplierId=f.id;i.QuoteSynId=n("#QuotesSynId").val();i.Status=0;n(".inputRepA_"+f.id).change(function(){i.RepresentA=n(this).val()});n(".inputPosiA_"+f.id).change(function(){i.PositionA=n(this).val()});n(".inputRepB_"+f.id).change(function(){i.RepresentB=n(this).val()});n(".inputPosiB_"+f.id).change(function(){i.PositionB=n(this).val()});n(".inputMouthNumber_"+f.id).change(function(){i.MouthNumber=n(this).val()});n(".inputPrice_"+f.id).change(function(){i.Price=n(this).val()});n(".inputIndemnify_"+f.id).change(function(){i.Indemnify=n(this).val()});n(".inputsellerDate_"+f.id).change(function(){i.SellerDate=n(this).val()});n(".inputBankName_"+f.id).change(function(){i.BankName=n(this).val()});n(".inputSTK_"+f.id).change(function(){i.Stk=n(this).val()})}})});n(".valueDate").text(s.getDate());n(".valueMonth").text(s.getMonth()+1);n(".valueYear").text(s.getFullYear())};n(".close-modal").on("click",function(){abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Đóng"),app.localize("Bạn có chắc không"),function(n){if(n)return i.close(),!0})});this.save=function(){var e={},o,u;for(console.log(t),o=t.length,u=0;u<t.length;u++)t[u].Number=u+1,r.create(t[u]).done(function(){});e.Id=n("#QuotesSynId").val();e.Status=4;f.updateStatus(e).done(function(){i.close();abp.notify.success(app.localize("Tạo hợp đồng thành công"));abp.event.trigger("app.reloadgetDocApprove");abp.event.trigger("app.reloadgetDocContact")}).always(function(){i.setBusy(!1)})}}}(jQuery),function(n){app.modals.CreateRejectModal=function(){var r=abp.services.app.quotesSynthesise,t,i=null;this.init=function(r){t=r;i=t.getModal().find("form[name=FrmCreateReject]");n(document).ready(function(){n("#Comment").summernote({height:270,forcus:!0})})};n(".close-modal").on("click",function(){abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Đóng"),app.localize("Bạn có chắc không"),function(n){if(n)return t.close(),!0})});this.save=function(){if(i.addClass("was-validated"),i[0].checkValidity()===!1){event.preventDefault();event.stopPropagation();return}var f=n("#Comment").summernote("code"),u=i.serializeFormToObject();u.status=3;u.Comment=f;t.setBusy(!0);u.link=window.location.href;r.update(u).done(function(){t.close();abp.notify.info("Từ chối thành công!");abp.event.trigger("app.reloadDocTable")}).always(function(){t.setBusy(!1)})}}}(jQuery);