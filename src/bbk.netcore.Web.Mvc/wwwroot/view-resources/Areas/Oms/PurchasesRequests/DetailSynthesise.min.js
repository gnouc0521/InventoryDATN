(function(){function h(){$("#Edit").is(":hidden")&&$("#SynTable tbody tr td input").removeAttr("disabled")}function i(){n.ajax.reload()}var o=$("#SynTable"),t=abp.services.app.purchasesSynthesise,r=abp.services.app.purchasesRequestDetailService,a=abp.services.app.sendMailService;moment.locale(abp.localization.currentLanguage.name);var u=[],f=[],e=0,s=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/PurchasesRequest/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/Oms/PurchasesRequests/_CreateModalContractReject.js",modalClass:"CreateRejectModal",modalType:"modal-xl"});var c=function(){$("#Edit").unbind("click").click(function(){$("#SynTable tbody tr td input").removeAttr("disabled");n.data().each(function(n){u.push(n.purchasesDetailId)});$(this).hide();$("#Save").show();$("#SendTo").attr("disabled",!0);n.column(9).visible(!0);$("#Save").removeAttr("hidden");$("#SynTable tbody tr td input").each(function(t,i){var r=[];$(i).change(function(){var t=$(this).val(),i=$(this).attr("data-objid");n.rows(function(u,f){if(f.purchasesDetailId===parseInt(i)){var e=f;e.quantityItems=parseInt(t);r.push(u);n.row(u).data(e).draw()}return!1})})})})},l=function(){let n={};return n.id=$("#SynthesiseId").val().trim(),n},n=o.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:15,listAction:{ajaxFunction:t.getAllItems,inputFilter:l},columnDefs:[{targets:0,orderable:!1,"class":"text-center",className:"dt-body-center text-center",render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,data:"itemsName"},{targets:2,data:"subsidiariesName",orderable:!1,autoWidth:!1},{targets:3,data:"supplierName",orderable:!1,autoWidth:!1},{targets:4,data:"unitName",orderable:!1,autoWidth:!1},{targets:5,data:"quantityItems",orderable:!1,autoWidth:!1,orderable:!0,render:function(n,t,i){return`<input class='form-control' data-objid="`+i.purchasesDetailId+`" value='`+i.quantityItems+`' disabled >`}},{targets:6,data:"purpose",orderable:!1,autoWidth:!1},{targets:7,data:"dateTimeNeed",orderable:!1,autoWidth:!1,render:function(n){return moment(n).format("L")}},{targets:8,data:"note",orderable:!1,autoWidth:!1},{targets:9,data:null,visible:!1,orderable:!1,autoWidth:!1,render:function(){return`<a class="delete_row" href='javascript:void(0);'><i class="fal fa-trash-alt  align-bottom "></i></a>`}},],fnDrawCallback:function(){e++;h();c(e)}}),v=function(n){var t=$($(n).find("tbody tr td input"));$.each(t,function(n,t){$(t).removeAttr("disabled")})};$("#SynTable").on("click",".delete_row",function(){n.row($(this).parents("tr")).remove().draw()});$("#Save").click(function(){var e=$(this),t=[];n.data().each(function(n){f.push(n.purchasesDetailId);let i={};i.id=n.purchasesDetailId;i.quantity=n.quantityItems;t.push(i)});abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Lưu thay đổi"),app.localize("Bạn có chắc không"),function(o){var s;if(o){n.column(9).visible(!1);let o=u.filter(n=>!f.includes(n));for(console.log(o),s=0;s<o.length;s++)r.delete(o[s]).done(function(){i()});for(s=0;s<t.length;s++)r.updateQuantity({id:t[s].id,quantity:t[s].quantity}).done(function(){i()});e.hide();$("#Edit").show();$("#SendTo").removeAttr("disabled");abp.notify.info("Chỉnh sửa phiếu tổng hợp thành công!")}})});$("#SendTo").click(function(){var i=$(this);let n={};abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Gửi phiếu yêu cầu tổng hợp"),app.localize("Bạn có chắc không"),function(r){r&&(n.purchasesRequestStatus=1,n.purchasesSynthesiseId=i[0].dataset.obj,n.email=$("#email").val(),n.link=window.location.href,n.name=$("#name").val(),t.updateStatus(n).done(function(){abp.notify.info("Gửi phiếu tổng hợp thành công!");i.hide();$("#Edit").hide();$("#Save").hide()}))})});$(".btn-browse").click(function(){var i=$(this);let n={};n.purchasesRequestStatus=2;n.purchasesSynthesiseId=i[0].dataset.quo;n.link=window.location.href;t.updateStatus(n).done(function(){abp.notify.info("Phê duyệt phiếu tổng hợp thành công!");$(".btn-browse").prop("hidden",!0);$(".btn-reject").prop("hidden",!0)})});$(".btn-reject").click(function(){var t=$(this),n;n={purchasesSynthesiseId:t[0].dataset.quo};n.link=window.location.href;s.open(n,function(){t.hide();$(".btn-browse").hide()})});abp.event.on("app.reloadDocTable",function(){i()});jQuery(document).ready(function(){$("#SearchTerm").focus()})})(jQuery);