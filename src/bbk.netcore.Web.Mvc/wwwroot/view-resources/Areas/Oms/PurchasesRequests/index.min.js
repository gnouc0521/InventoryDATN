(function(){function t(){u.ajax.reload();n.ajax.reload()}var e=$("#PurchasesRequestTable"),o=$("#AllRequestTable"),s=$("#AllRequestTableConfirm"),i=abp.services.app.purchasesRequestsService,r=abp.services.app.purchasesSynthesise,h=abp.services.app.userWorkCountService,f,n;moment.locale(abp.localization.currentLanguage.name);var c=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/PurchasesRequest/CreatePurchasesRequest",scriptUrl:abp.appPath+"view-resources/Areas/Oms/PurchasesRequests/_CreateModal.js",modalClass:"PurchasesRequestCreateModal",modalType:"modal-xl"}),l=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/PurchasesRequest/UpdatePurchasesRequest",scriptUrl:abp.appPath+"view-resources/Areas/Oms/PurchasesRequests/_EditModal.js",modalClass:"PurchasesRequestEditModal",modalType:"modal-xl"}),a=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/PurchasesRequest/ViewDetails",scriptUrl:abp.appPath+"view-resources/Areas/Oms/PurchasesRequests/ViewDetail.js",modalClass:"ViewModal",modalType:"modal-xl"});$("#CreateNewButtonxx").click(function(){c.open()});$(".date-picker").datepicker({rtl:!1,format:"dd/mm/yyyy",orientation:"left",autoclose:!0,language:abp.localization.currentLanguage.name});f=function(){return dataFilter.searchTerm=$("#SearchTerm").val(),dataFilter};n=e.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:5,listAction:{ajaxFunction:i.getAll},order:[[1,"asc"]],columnDefs:[{targets:0,orderable:!1,className:"dt-body-center text-center",render:function(n,t,i){return i.requestStatus==0?'<input type="checkbox" name="" data-value="'+i.id+'" disabled>':'<input type="checkbox" name="" data-value="'+i.id+'">'}},{searchable:!1,orderable:!1,targets:1,render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:2,data:"subsidiaryCompany",render:function(n,t,i){return`
                        <a class="viewsubsidiaryCompany" data-viewid='`+i.id+`' href='javascript:void(0); '>`+i.subsidiaryCompany+`</a>
                    `}},{orderable:!1,targets:3,data:"address"},{orderable:!1,targets:4,data:"phoneNumber"},{orderable:!1,targets:5,data:"emailAddress"},{targets:6,data:"requestDate",render:function(n){return moment(n).format("L")}},{orderable:!1,targets:7,data:"requestStatus",render:function(n){return n==2?`<span class="span_status span-defaut"> Chưa tổng hợp </span>`:n==0?`<span class="span_status span-approve"> Đã tổng hợp </span>`:void 0}},{targets:8,data:null,"class":"text-center",orderable:!1,autoWidth:!1,render:function(n,t,i){return`                        
                            <div class='dropdown d-inline-block'>
                            	<a href='#'' class='btn btn-sm btn-icon btn-outline-primary rounded-circle shadow-0' data-toggle='dropdown' aria-expanded='true' title='More options'>
                            		<i class="fal fa-ellipsis-v"></i>
                            	</a>
                            	<div class='dropdown-menu'>
                                    <a class='dropdown-item doceditfunc'data-objid='`+i.id+`'href='javascript:void(0); ' ><i class="fal fa-edit"></i> Chỉnh Sửa </a>
                            	</div>
                            </div>`}}]});abp.event.on("app.reloadDocTable",function(){t()});$("#PurchasesRequestTable").on("click",".doceditfunc",function(){var n=$(this),t={id:n[0].dataset.objid};l.open(t)});$("#PurchasesRequestTable").on("click",".viewsubsidiaryCompany",function(){var n=$(this),t={id:n[0].dataset.viewid};abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/PurchasesRequest/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/PurchasesRequest/ViewDetails?id="+n.id}})});$("#Search").click(function(n){n.preventDefault();t()});jQuery(document).ready(function(){$("#SearchTerm").focus()});$("#example-select-all").on("click",function(){var i=n.rows({search:"applied"}).nodes(),t;$('input[type="checkbox"]',i).not(":disabled").prop("checked",this.checked);$("#RequestAll").removeAttr("disabled");t=[];$('#PurchasesRequestTable tbody input[type="checkbox"]:checked').each(function(){t.push($(this))});t.length>0?$("#RequestAll").removeAttr("disabled"):$("#RequestAll").prop("disabled",!0);console.log(t)});$("#PurchasesRequestTable tbody").on("change",'input[type="checkbox"]',function(){var t=[],n;$('#PurchasesRequestTable tbody input[type="checkbox"]:checked').each(function(){t.push($(this))});t.length>0?$("#RequestAll").removeAttr("disabled"):$("#RequestAll").prop("disabled",!0);this.checked||(n=$("#example-select-all").get(0),n&&n.checked&&"indeterminate"in n&&(n.indeterminate=!0))});n.$('input[type="checkbox"]').each(function(n,t){t>0&&$("#RequestAll").removeAttr("disabled")});$("#RequestAll").on("click",function(){abp.message.confirm(app.localize("Bạn có chắc chắn muốn tổng hợp yêu cầu mua hàng không"),app.localize("Tổng hợp yêu cầu"),function(u){u&&r.create({}).done(function(r){n.$('input[type="checkbox"]').each(function(n,u){if($(u).is(":checked")){let n={};n.Id=$(u).attr("data-value");n.PurchasesSynthesiseId=r;i.updateSynId(n).done(function(){t();n.purchasesRequestId=$(u).attr("data-value");n.workStatus=0;h.updateSys(n)})}})})})});$("#example-select-all").on("click",function(){var i=n.rows({search:"applied"}).nodes(),t;$('input[type="checkbox"]',i).not(":disabled").prop("checked",this.checked);$("#DeleteP").removeAttr("disabled");t=[];$('#PurchasesRequestTable tbody input[type="checkbox"]:checked').each(function(){t.push($(this))});t.length>0?$("#DeleteP").removeAttr("disabled"):$("#DeleteP").prop("disabled",!0);console.log(t)});$("#PurchasesRequestTable tbody").on("change",'input[type="checkbox"]',function(){var t=[],n;$('#PurchasesRequestTable tbody input[type="checkbox"]:checked').each(function(){t.push($(this))});t.length>0?$("#DeleteP").removeAttr("disabled"):$("#DeleteP").prop("disabled",!0);this.checked||(n=$("#example-select-all").get(0),n&&n.checked&&"indeterminate"in n&&(n.indeterminate=!0))});$("#DeleteP").on("click",function(){abp.message.confirm(app.localize("Bạn có chắc chắn muốn xoá cầu mua hàng không"),app.localize("Xoá yêu cầu"),function(r){r&&n.$('input[type="checkbox"]').each(function(n,r){$(r).is(":checked")&&(console.log(r),i.delete($(r).attr("data-value")).done(function(){abp.notify.success(app.localize("Xóa phiếu thành công"));t()}))})})});var f=function(){let n;return n},u=o.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:r.getAll,inputFilter:f},rowsGroup:{dataSrc:2},order:[[1,"asc"]],columnDefs:[{targets:0,orderable:!1,className:"dt-body-center text-center",render:function(n,t,i){return'<input type="checkbox" name="" data-value="'+i.id+'">'}},{orderable:!1,targets:1,data:null,render:function(n,t,i,r){return r.row+1}},{name:"first",orderable:!1,targets:2,data:"purchasesSynthesiseCode",render:function(n,t,i){return`
                        <a class="purchasesSynthesiseCode" data-objid='`+i.id+`' href='javascript:void(0); '>`+i.purchasesSynthesiseCode+`</a>
                    `}},{orderable:!1,targets:3,data:"subsidiaries",render:function(n,t,i){for(var u="",r=0;r<i.subsidiaries.length;r++)u+=`<span class="mb-1"> `+i.subsidiaries[r]+`</span><br>`;return u}},{orderable:!1,targets:4,data:"creationTime",render:function(n){return moment(n).format("L")}},{orderable:!1,targets:5,data:"purchasesRequestStatus",render:function(n,t,i){return i.purchasesRequestStatus==0?`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Chưa xử lý</span>`:i.purchasesRequestStatus==2?`<span class="btn btn-outline-secondary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-approve">Đã phê duyệt</span>`:i.purchasesRequestStatus==1?abp.session.userId!=i.creatorUserId?`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Chưa xử lý</span>`:`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Đã gửi</span>`:i.purchasesRequestStatus==3?`<span class="btn btn-outline-secondary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-reject">Bị từ chối</span>`:void 0}},{targets:6,data:null,"class":"text-center",orderable:!1,autoWidth:!1,render:function(n,t,i){return`                        
                            <div class='dropdown d-inline-block'>
                            	<a href='#'' class='btn btn-sm btn-icon btn-outline-primary rounded-circle shadow-0' data-toggle='dropdown' aria-expanded='true' title='More options'>
                            		<i class="fal fa-ellipsis-v"></i>
                            	</a>
                            	<div class='dropdown-menu'>
                            		<a class='dropdown-item docview'data-objid='`+i.id+`'href='javascript:void(0); ' ><i class="fal fa-eye"></i> Chi tiết </a>
                            	</div>
                            </div>`}}]}),v=s.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:r.getAllConfirm,inputFilter:f},rowsGroup:{dataSrc:2},order:[[0,"asc"]],columnDefs:[{orderable:!1,targets:0,data:null,render:function(n,t,i,r){return r.row+1}},{name:"first",orderable:!1,targets:1,data:"purchasesSynthesiseCode",render:function(n,t,i){return`
                        <a class="purchasesSynthesiseCode" data-objid='`+i.id+`' href='javascript:void(0); '>`+i.purchasesSynthesiseCode+`</a>
                    `}},{orderable:!1,targets:2,data:"subsidiaries",render:function(n,t,i){for(var u="",r=0;r<i.subsidiaries.length;r++)u+=`<span class="mb-1"> `+i.subsidiaries[r]+`</span><br>`;return u}},{orderable:!1,targets:3,data:"creationTime",render:function(n){return moment(n).format("L")}},{orderable:!1,targets:4,data:"purchasesRequestStatus",render:function(n,t,i){return i.purchasesRequestStatus==0?`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Chưa xử lý</span>`:i.purchasesRequestStatus==2?`<span class="btn btn-outline-secondary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-approve">Đã phê duyệt</span>`:i.purchasesRequestStatus==1?abp.session.userId!=i.creatorUserId?`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Chưa xử lý</span>`:`<span class="btn btn-outline-primary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-defaut">Đã gửi</span>`:i.purchasesRequestStatus==3?`<span class="btn btn-outline-secondary btn-pills btn-sm btn-w-m  mr-1 waves-effect waves-themed span_status span-reject">Bị từ chối</span>`:void 0}},{targets:5,data:null,"class":"text-center",orderable:!1,autoWidth:!1,render:function(n,t,i){return`                        
                            <div class='dropdown d-inline-block'>
                            	<a href='#'' class='btn btn-sm btn-icon btn-outline-primary rounded-circle shadow-0' data-toggle='dropdown' aria-expanded='true' title='More options'>
                            		<i class="fal fa-ellipsis-v"></i>
                            	</a>
                            	<div class='dropdown-menu'>
                            		<a class='dropdown-item docview'data-objid='`+i.id+`'href='javascript:void(0); ' ><i class="fal fa-eye"></i> Chi tiết </a>
                            	</div>
                            </div>`}}]});abp.event.on("app.reloadDocTable",function(){t()});$("#AllRequestTableConfirm").on("click",".docview,.purchasesSynthesiseCode",function(){var n=$(this),t={id:n[0].dataset.objid};console.log("aa");abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/ImportRequest/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/PurchasesRequest/DetailSynthesise?SynthesiseId="+n.id}})});$("#AllRequestTable").on("click",".docview,.purchasesSynthesiseCode",function(){var n=$(this),t={id:n[0].dataset.objid};console.log("aa");abp.ajax({contentType:"application/x-www-form-urlencoded",url:abp.appPath+"Inventorys/ImportRequest/OverView?Id="+t.id,success:function(n){window.location.href="/Inventorys/PurchasesRequest/DetailSynthesise?SynthesiseId="+n.id}})});$("#example-select-all1").on("click",function(){var t=u.rows({search:"applied"}).nodes(),n;$('input[type="checkbox"]',t).prop("checked",this.checked);$("#DeleteAll").removeAttr("disabled");n=[];$('#AllRequestTable tbody input[type="checkbox"]:checked').each(function(){n.push($(this))});n.length>0?$("#DeleteAll").removeAttr("disabled"):$("#DeleteAll").prop("disabled",!0);console.log(n)});$("#AllRequestTable tbody").on("change",'input[type="checkbox"]',function(){var t=[],n;$('#AllRequestTable tbody input[type="checkbox"]:checked').each(function(){t.push($(this))});t.length>0?$("#DeleteAll").removeAttr("disabled"):$("#DeleteAll").prop("disabled",!0);this.checked||(n=$("#example-select-all1").get(0),n&&n.checked&&"indeterminate"in n&&(n.indeterminate=!0))});u.$('input[type="checkbox"]').each(function(n,t){t>0&&$("#DeleteAll").removeAttr("disabled")});$("#DeleteAll").on("click",function(){abp.message.confirm(app.localize("Bạn có chắc chắn muốn xóa phiếu tổng hợp không "),app.localize("Xóa phiếu tổng hợp"),function(n){n&&u.$('input[type="checkbox"]').each(function(n,u){$(u).is(":checked")&&(console.log(u),r.delete($(u).attr("data-value")).done(function(n){$.each(n,function(n,t){let r={};r.Id=t;i.updateSynId(r)});$("#example-select-all1").prop("checked",!1);abp.notify.success(app.localize("Xóa phiếu tổng hợp thành công"));t()}));console.log($(u).val())})})})})(jQuery),function(n){app.modals.PurchasesRequestCreateModal=function(){var c=n("#ItemTable"),h=abp.services.app.purchasesRequestsService,u=abp.services.app.purchasesRequestDetailService,f=abp.services.app.subsidiaryService,e=abp.services.app.itemsService,o=abp.services.app.unitService,s=abp.services.app.supplier,r,t=null;this.init=function(u){function h(){n(".delete_row").click(function(){n(this).parents("tr").remove()})}function l(n){var t=n+1;return html=`<tr>
                                <th>`+t+`</th>
                                <th><select  class="form-control selectExport ItemId" style="width:100%"  required>
                                <option value="" selected=""> Chọn hàng hóa </option>
                                </select></th>
                                <th><select  class="form-control selectSupplier SupplierId" style="width:100%"  required>
                                <option value="" selected=""> Chọn NCC </option>
                                </select></th>
                                <th><select size="1" id="row-1-office" class="form-control selectUnit UnitId" name="UnitId"  required >
                                <option value="" selected=""> Chọn đơn vị tính </option>
                                </select></th>
                                <th><input type="number" id="row-1-age" name="Quantity" class="form-control Quantity" value="" required></th>
                                <th><input type="text" id="Uses" name="Uses" class="form-control Uses" value="" required></th>
                                <th><input type="text" autocomplete="off" class="form-control date-picker requestDate" value="" placeholder="Nhập ngày" id="requestDate" name="requestDate" required></th>
                                <th><input type="text" id="Note" name="Note" class="form-control Note" value="" required></th>
                               <th class="text-center"><a class="delete_row" href='javascript:void(0);'><i class="fal fa-trash-alt  align-bottom "></i></a> </th>
                            </tr>`}function a(){o.getAll({}).done(function(t){n.each(t.items,function(t,i){i.parrentId==null&&(optgroup=`<optgroup data-parrent=`+i.id+` label="`+i.name+`">`+`</optgroup>`,n(".UnitId option:last").after(optgroup))});var i=n(".UnitId optgroup");n.each(i,function(i,r){let u=r.dataset.parrent;n.each(t.items,function(t,i){i.parrentId==u&&(option=`<option value="`+i.id+`">`+i.name+`</option>`,n(r).append(option))})})})}function c(n){var t=n.target.files,i=new v;i.parseExcel(t[0])}function y(){var n=t.find("input[name=PhoneNumber]").val();return n.substring(0,1)==0?t.find("input[name=PhoneNumber]").val().replace("0",""):t.find("input[name=PhoneNumber]").val().replace(/[^0-9]/g,"")}r=u;t=r.getModal().find("form[name=frmCreate]");n("#SubsidiaryCompanyId").on("change",function(){n("#ItemTable tbody tr").remove();n("#addRow").attr("disabled",!1);n("#fileupload").attr("disabled",!1);document.getElementById("fileupload").addEventListener("change",c,!1);var t=function(){let t={};return t.subsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),t.subsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),t};f.getAllPurchese(t()).done(function(t){n.each(t.items,function(i,r){function u(t,i,r,u){f.getAddress(t,i).done(t=>{for(let i=0;i<t.addresses.length;i++)t.addresses[i].id==r&&(e+=t.addresses[i].name+" , ",n(u).val(e))})}console.log(t.items);fullPathProvince="province.json";fullPathDistrict="district.json";fullPathVillage="village.json";var e="";u(fullPathProvince,"",r.cityId,"#Address");u(fullPathDistrict,r.cityId,r.districtId,"#Address");u(fullPathVillage,r.districtId,r.wardsId,"#Address");n("#PhoneNumber").val(r.phoneNumber);n("#EmailAddress").val(r.emailAddress)})})});n("#addRow").click(function(){e.getItemImportList().done(function(t){s.getSupplierList().done(function(i){var r=n.map(t,function(n){return n.id=n.id,n.text=n.itemCode+"/"+n.name,n}),u=n.map(i,function(n){return n.id=n.id,n.text=n.code,n}),f=n("#ItemTable tbody tr").length;n("#ItemTable tbody ").append(l(f));h();a();n(".selectSupplier").eq(0).trigger("change");n(".selectSupplier").select2({width:"100%",dropdownParent:n("#ItemsCreateModal"),placeholder:"Chọn hàng hóa",data:u}).on("select2:select",function(){}).trigger("change");n("#ItemTable tbody .selectExport").change(function(){var t=[],i;n("#ItemTable tbody .selectExport").each(function(){t.push(this.value)});i=n(this).parents("th").find("select");n(i).find("option").removeAttr("disabled").filter(function(){var i=n(this).parent("select").val();return n.inArray(this.value,t)>-1&&this.value!=i}).attr("disabled","disabled")});n(".selectExport").eq(0).trigger("change");n(".selectExport").select2({width:"100%",dropdownParent:n("#ItemsCreateModal"),placeholder:"Chọn hàng hóa",data:r}).on("select2:select",function(){}).trigger("change");n(".date-picker").datepicker({rtl:!1,format:"dd/mm/yyyy",orientation:"left",autoclose:!0,language:abp.localization.currentLanguage.name})});h()})});var v=function(){this.parseExcel=function(t){if(t.size>10485760)return abp.message.warn(app.localize("File_SizeLimit_Error")),!1;var r=new FileReader;r.onload=function(t){var u=t.target.result,r=XLSX.read(u,{type:"binary"});r.SheetNames.forEach(function(t){var s=XLSX.utils.sheet_to_row_object_array(r.Sheets[t],{raw:!1}),u=JSON.parse(JSON.stringify(s)),h=n("#ItemTable thead tr").find("th").length-1,c=Object.keys(u[0]).length,f=u[0].__EMPTY_1,l=u[0].__EMPTY_6,a=n("#ItemTable thead tr").find("th")[1].innerText,v=n("#ItemTable thead tr").find("th")[6].innerText,e,o;if(c==h&&a.indexOf(f)!=1&&v.indexOf(l)!=1&&f!=undefined)for(e=n("#ItemTable").DataTable({paging:!0,serverSide:!1,processing:!1,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:5,columnDefs:[{targets:0},{targets:1},{targets:2},{targets:3},{targets:4},{targets:5},{targets:6},{targets:7},{targets:8,render:function(){return` <th class="text-center"></th>`}}]}),i=1;i<u.length;i++)o=Object.values(u[i]),e.rows.add([o]).draw();else return abp.message.error("File không đúng định dạng","Mời chọn lại file theo mẫu"),!1})};r.onerror=function(){};r.readAsBinaryString(t)}};document.getElementById("fileupload").addEventListener("change",c,!1);n("#fileupload").on("change",function(){n("#ItemTable").DataTable().destroy()});document.getElementById("PhoneNumber").addEventListener("input",function(){var n=y();t.find("input[name=PhoneNumber]").val(n)})};n(".cancel-work-button").click(function(){abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Đóng"),app.localize("Bạn có chắc không"),function(n){if(n)return r.close(),!0})});this.save=function(){var f,i;if(t.addClass("was-validated"),t[0].checkValidity()===!1){event.preventDefault();event.stopPropagation();return}f=n("#ItemTable tbody tr").length;f==0?(abp.message.warn(app.localize("Chưa nhập dữ liệu bảng hàng hoá")),n("#ItemTable").DataTable().destroy()):(i=t.serializeFormToObject(),i.requestStatus=2,r.setBusy(!0),h.create(i).done(function(t){if(r.close(),abp.notify.info("Thêm mới phiếu yêu cầu thành công!"),abp.event.trigger("app.reloadDocTable"),document.getElementById("fileupload").files.length==0)n("#ItemTable tbody tr").each(function(r,f){i.PurchasesRequestId=t;i.SubsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val();i.ItemId=n(f).children("th").find(".ItemId option:selected").val();i.SupplierId=n(f).children("th").find(".SupplierId option:selected").val();i.Quantity=n(f).children("th").find(".Quantity ").val();i.UnitId=n(f).children("th").find(".UnitId option:selected").val();i.Uses=n(f).children("th").find(".Uses").val();i.TimeNeeded=n(f).children("th").find(".requestDate ").val();i.Note=n(f).children("th").find(".Note").val();u.create(i)});else{var f=n("#ItemTable").DataTable().rows().data();f.each(function(r){e.getItemByCode(r[1]).done(function(f){o.getUnitByText(r[3]).done(function(e){s.getSupByCode(r[2]).done(function(o){i.PurchasesRequestId=t;i.SubsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val();i.ItemId=f.id;i.SupplierId=o.id;i.Quantity=r[4];i.UnitId=e.id;i.Uses=r[5];i.TimeNeeded=r[6];i.Note=r[7];u.create(i)})})})})}}).always(function(){r.setBusy(!1)}))}}}(jQuery),function(n){app.modals.PurchasesRequestEditModal=function(){var a=n("#ItemTable"),l=abp.services.app.purchasesRequestsService,u=abp.services.app.purchasesRequestDetailService,f=abp.services.app.subsidiaryService,e=abp.services.app.itemsService,o=abp.services.app.unitService,s=abp.services.app.supplier,r,t=null,h=[],c=[];this.init=function(c){function l(){n(".delete_row").click(function(){n(this).parents("tr").remove()})}function v(){o.getAll({}).done(function(t){n.each(t.items,function(t,i){i.parrentId==null&&(optgroup=`<optgroup data-parrent=`+i.id+` label="`+i.name+`">`+`</optgroup>`,n(".UnitId option:last").after(optgroup))});var i=n(".UnitId optgroup");n.each(i,function(i,r){let u=r.dataset.parrent;n.each(t.items,function(t,i){i.parrentId==u&&(option=`<option value="`+i.id+`">`+i.name+`</option>`,n(r).append(option))})})})}function p(n){var t=n.target.files,i=new y;i.parseExcel(t[0])}function w(){var n=t.find("input[name=PhoneNumber]").val();return n.substring(0,1)==0?t.find("input[name=PhoneNumber]").val().replace("0",""):t.find("input[name=PhoneNumber]").val().replace(/[^0-9]/g,"")}var a,y;r=c;t=r.getModal().find("form[name=FrmEdit]");n("#SubsidiaryCompanyId").val(n("#SubsidiaryCompanyId_hidden").val());n("#SubsidiaryCompanyId").on("change",function(){n("#ItemTable tbody tr").remove();var t=function(){let t={};return t.subsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),t.subsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),t};f.getAllPurchese(t()).done(function(t){n.each(t.items,function(t,i){function r(t,i,r,e){f.getAddress(t,i).done(t=>{for(let i=0;i<t.addresses.length;i++)t.addresses[i].id==r&&(u+=t.addresses[i].name+" , ",n(e).val(u))})}fullPathProvince="province.json";fullPathDistrict="district.json";fullPathVillage="village.json";var u="";r(fullPathProvince,"",i.cityId,"#Address");r(fullPathDistrict,i.cityId,i.districtId,"#Address");r(fullPathVillage,i.districtId,i.wardsId,"#Address");n("#PhoneNumber").val(i.phoneNumber);n("#EmailAddress").val(i.emailAddress)})})});a=function(){let t={};return t.purchasesRequestId=n("#Id").val(),t.subsidiaryId=n("#SubsidiaryCompanyId_hidden").val(),t.subsidiaryCompanyId=n("#SubsidiaryCompanyId_hidden").val(),t};f.getAllPurchese(a()).done(function(t){n.each(t.items,function(t,i){function r(t,i,r,e){f.getAddress(t,i).done(t=>{for(let i=0;i<t.addresses.length;i++)t.addresses[i].id==r&&(u+=t.addresses[i].name+" , ",n(e).val(u))})}fullPathProvince="province.json";fullPathDistrict="district.json";fullPathVillage="village.json";var u="";r(fullPathProvince,"",i.cityId,"#Address");r(fullPathDistrict,i.cityId,i.districtId,"#Address");r(fullPathVillage,i.districtId,i.wardsId,"#Address");n("#PhoneNumber").val(i.phoneNumber);n("#EmailAddress").val(i.emailAddress)})});e.getItemList().done(function(){function t(n){var t=n+1;return html=`<tr>
                                <th>`+t+`</th>
                                <th><select  class="form-control selectExport ItemId" style="width:100%"  required>
                                <option value="" selected=""> Chọn hàng hóa </option>
                                </select></th>
                                <th><select  class="form-control selectSupplier SupplierId" style="width:100%"  required>
                                <option value="" selected=""> Chọn NCC </option>
                                </select></th>
                                <th><select class="form-control selectUnit UnitId" style="width:100%"  required >
                                <option value="" selected=""> Chọn đơn vị tính </option>
                                </select></th>
                                <th><input type="number" id="row-1-age" name="Quantity" class="form-control Quantity" value="" required></th>
                                <th><input type="text" id="Uses" name="Uses" class="form-control Uses" value="" required></th>
                                <th><input type="text" autocomplete="off" class="form-control date-picker requestDate" value="" placeholder="Nhập ngày" id="requestDate" name="requestDate" required></th>
                                <th><input type="text" id="Note" name="Note" class="form-control Note" value="" required></th>
                               <th class="text-center"><a class="delete_row" href='javascript:void(0);'><i class="fal fa-trash-alt  align-bottom "></i></a> </th>
                            </tr>`}u.getAll(a()).done(function(i){n.each(i.items,function(i,r){h.push(r.id.toString());var u=n("#ItemTable tbody tr").length;n("#ItemTable tbody").append(t(u));l();v()});n("#ItemTable").paging({limit:5,rowDisplayStyle:"block",activePage:0,rows:[]});e.getItemImportList().done(function(t){s.getSupplierList().done(function(r){o.getUnitList().done(function(u){n.each(n(".selectExport"),function(i){var r=n(".selectExport");n.each(t,function(t,u){abc=`<option value=`+u.id+`>`+u.itemCode+"/"+u.name+`</option>`;n(r[i]).children("option:last").after(abc)})});n.each(n(".selectSupplier"),function(t){var i=n(".selectSupplier");n.each(r,function(r,u){abc=`<option value=`+u.id+`>`+u.code+`</option>`;n(i[t]).children("option:last").after(abc)})});n.each(n(".selectUnit"),function(t){var i=n(".selectUnit");n.each(u,function(r,u){abc=`<option value=`+u.id+`>`+u.name+`</option>`;n(i[t]).children("option:last").after(abc)})});n.each(i.items,function(t,i){var r=n("#ItemTable tbody tr");n(r[t]).children("th:first").attr("data-id",i.id);n(r[t]).children("th").find(".ItemId").val(i.itemId);n(r[t]).children("th").find(".SupplierId").val(i.supplierId);n(r[t]).children("th").find(".UnitId").val(i.unitId);n(r[t]).children("th").find(".Quantity").val(i.quantity);n(r[t]).children("th").find(".Uses").val(i.uses);n(r[t]).children("th").find(".requestDate").val(moment(i.requestDate).format("L"));n(r[t]).children("th").find(".Note").val(i.note)})})})});n(".date-picker").datepicker({rtl:!1,format:"dd/mm/yyyy",orientation:"left",autoclose:!0,language:abp.localization.currentLanguage.name})});n("#addRow").click(function(){e.getItemImportList().done(function(i){s.getSupplierList().done(function(r){var u=n.map(i,function(n){return n.id=n.id,n.text=n.itemCode+"/"+n.name,n}),f=n.map(r,function(n){return n.id=n.id,n.text=n.code,n}),e=n("#ItemTable tbody tr").length;n("#ItemTable tbody ").append(t(e));l();v();n(".selectSupplier").eq(0).trigger("change");n(".selectSupplier").select2({width:"100%",dropdownParent:n("#PurchesRequestsEditModal"),placeholder:"Chọn hàng hóa",data:f}).on("select2:select",function(){}).trigger("change");n("#ItemTable tbody .selectExport").change(function(){var t=[],i;n("#ItemTable tbody .selectExport").each(function(){t.push(this.value)});i=n(this).parents("th").find("select");n(i).find("option").removeAttr("disabled").filter(function(){var i=n(this).parent("select").val();return n.inArray(this.value,t)>-1&&this.value!=i}).attr("disabled","disabled")});n(".selectExport").eq(0).trigger("change");n(".selectExport").select2({width:"100%",dropdownParent:n("#PurchesRequestsEditModal"),placeholder:"Chọn hàng hóa",data:u}).on("select2:select",function(){}).trigger("change");n(".date-picker").datepicker({rtl:!1,format:"dd/mm/yyyy",orientation:"left",autoclose:!0,language:abp.localization.currentLanguage.name})});l()})})});y=function(){this.parseExcel=function(t){if(t.size>10485760)return abp.message.warn(app.localize("File_SizeLimit_Error")),!1;var r=new FileReader;r.onload=function(t){var u=t.target.result,r=XLSX.read(u,{type:"binary"});r.SheetNames.forEach(function(t){var e=XLSX.utils.sheet_to_row_object_array(r.Sheets[t],{raw:!1}),u=JSON.parse(JSON.stringify(e)),o=n("#ItemTable").DataTable({paging:!0,serverSide:!1,processing:!1,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:5,columnDefs:[{targets:0},{targets:1},{targets:2},{targets:3},{targets:4},{targets:5},{targets:6},{targets:7},{targets:8,render:function(){return` <th class="text-center"><a class="delete_row" href='javascript: void (0);'><i class="fal fa-trash-alt  align-bottom "></i></a> </th>`}}]}),f;for(i=0;i<u.length;i++)f=Object.values(u[i]),o.rows.add([f]).draw(),l()})};r.onerror=function(){};r.readAsBinaryString(t)}};document.getElementById("fileupload").addEventListener("change",p,!1);n("#fileupload").on("change",function(){n("#ItemTable").DataTable().destroy()});document.getElementById("PhoneNumber").addEventListener("input",function(){var n=w();t.find("input[name=PhoneNumber]").val(n)})};n(".cancel-work-button").click(function(){abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Đóng phiếu nhập"),app.localize("Bạn có chắc không"),function(n){if(n)return r.close(),!0})});this.save=function(){var f,i;if(t.addClass("was-validated"),t[0].checkValidity()===!1){event.preventDefault();event.stopPropagation();return}f=n("#ItemTable tbody tr").length;f==0?(abp.message.warn(app.localize("Chưa nhập dữ liệu bảng hàng hoá")),n("#ItemTable").DataTable().destroy()):(i=t.serializeFormToObject(),i.requestStatus=2,r.setBusy(!0),l.update(i).done(function(t){function e(n){u.delete(n)}r.close();abp.notify.info("Sửa thành công!");abp.event.trigger("app.reloadDocTable");n("#ItemTable tbody tr").each(function(r,f){i.Id=n(f).children("th:first").attr("data-id");i.Id!=undefined?(c.push(i.Id),i.PurchasesRequestId=t,i.SubsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),i.ItemId=n(f).children("th").find(".ItemId option:selected").val(),i.SupplierId=n(f).children("th").find(".SupplierId option:selected").val(),i.Quantity=n(f).children("th").find(".Quantity ").val(),i.UnitId=n(f).children("th").find(".UnitId option:selected").val(),i.Uses=n(f).children("th").find(".Uses").val(),i.TimeNeeded=n(f).children("th").find(".requestDate ").val(),i.Note=n(f).children("th").find(".Note").val(),u.update(i)):(i.PurchasesRequestId=t,i.SubsidiaryCompanyId=n("#SubsidiaryCompanyId").find(":selected").val(),i.ItemId=n(f).children("th").find(".ItemId option:selected").val(),i.SupplierId=n(f).children("th").find(".SupplierId option:selected").val(),i.Quantity=n(f).children("th").find(".Quantity ").val(),i.UnitId=n(f).children("th").find(".UnitId option:selected").val(),i.Uses=n(f).children("th").find(".Uses").val(),i.TimeNeeded=n(f).children("th").find(".requestDate ").val(),i.Note=n(f).children("th").find(".Note").val(),u.create(i))});let f=h.filter(n=>!c.includes(n));f.forEach(e)}).always(function(){r.setBusy(!1)}))}}}(jQuery),function(){function n(n,t,i,u){r.getAddress(n,t).done(n=>{for(let t=0;t<n.addresses.length;t++)n.addresses[t].id==i&&$(u).html(n.addresses[t].name)})}var t=$("#ItemTable"),e=$("#PrintTable"),o=abp.services.app.purchasesRequestsService,i=abp.services.app.purchasesRequestDetailService,r=abp.services.app.subsidiaryService,s=new app.ModalManager({viewUrl:abp.appPath+"PersonalProfile/ImportRequest/Print",modalClass:"PrintModal",modalType:"modal-xl"}),u=function(){let n={};var t=window.location.href,i=t.substring(t.lastIndexOf("=")+1);return n.purchasesRequestId=$("#Id").val(),n},f;fullPathProvince="province.json";fullPathDistrict="district.json";fullPathVillage="village.json";n(fullPathProvince,"",$("#CityId").val(),"#CityName");n(fullPathDistrict,$("#CityId").val(),$("#DistrictId").val(),"#DistrictName");n(fullPathVillage,$("#DistrictId").val(),$("#WardsId").val(),"#VillageName");f=t.DataTable({paging:!1,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!1,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:10,listAction:{ajaxFunction:i.getAll,inputFilter:u},columnDefs:[{orderable:!1,targets:0,render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,data:"nameItem"},{orderable:!1,targets:2,data:"nameNCC"},{orderable:!1,targets:3,data:"nameUnit"},{orderable:!1,targets:4,data:"quantity",render:$.fn.dataTable.render.number(",",",","")},{orderable:!1,targets:5,data:"uses"},{orderable:!1,targets:6,data:"timeNeeded",render:function(n){return moment(n).format("L")}},{orderable:!1,targets:7,data:"note"},],footerCallback:function(){var t=this.api(),n=function(n){return typeof n=="string"?n.replace(/[\$,]/g,"")*1:typeof n=="number"?n:0},i;total=t.column(4).data().reduce(function(t,i){return n(t)+n(i)},0);pageTotal=t.column(4,{page:"current"}).data().reduce(function(t,i){return n(t)+n(i)},0);i=$.fn.dataTable.render.number(",",",","").display;$(t.column(4).footer()).html(i(pageTotal))}})}(jQuery),function(){function h(){$("#Edit").is(":hidden")&&$("#SynTable tbody tr td input").removeAttr("disabled")}function i(){n.ajax.reload()}var o=$("#SynTable"),t=abp.services.app.purchasesSynthesise,r=abp.services.app.purchasesRequestDetailService,a=abp.services.app.sendMailService;moment.locale(abp.localization.currentLanguage.name);var u=[],f=[],e=0,s=new app.ModalManager({viewUrl:abp.appPath+"Inventorys/PurchasesRequest/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/Oms/PurchasesRequests/_CreateModalContractReject.js",modalClass:"CreateRejectModal",modalType:"modal-xl"});var c=function(){$("#Edit").unbind("click").click(function(){$("#SynTable tbody tr td input").removeAttr("disabled");n.data().each(function(n){u.push(n.purchasesDetailId)});$(this).hide();$("#Save").show();$("#SendTo").attr("disabled",!0);n.column(9).visible(!0);$("#Save").removeAttr("hidden");$("#SynTable tbody tr td input").each(function(t,i){var r=[];$(i).change(function(){var t=$(this).val(),i=$(this).attr("data-objid");n.rows(function(u,f){if(f.purchasesDetailId===parseInt(i)){var e=f;e.quantityItems=parseInt(t);r.push(u);n.row(u).data(e).draw()}return!1})})})})},l=function(){let n={};return n.id=$("#SynthesiseId").val().trim(),n},n=o.DataTable({paging:!0,serverSide:!1,processing:!0,searching:!1,language:{emptyTable:"Không tìm thấy dữ liệu",lengthMenu:"Hiển thị _MENU_ bản ghi"},bInfo:!1,bLengthChange:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"Tất cả"],],pageLength:15,listAction:{ajaxFunction:t.getAllItems,inputFilter:l},columnDefs:[{targets:0,orderable:!1,"class":"text-center",className:"dt-body-center text-center",render:function(n,t,i,r){return r.row+1}},{orderable:!1,targets:1,data:"itemsName"},{targets:2,data:"subsidiariesName",orderable:!1,autoWidth:!1},{targets:3,data:"supplierName",orderable:!1,autoWidth:!1},{targets:4,data:"unitName",orderable:!1,autoWidth:!1},{targets:5,data:"quantityItems",orderable:!1,autoWidth:!1,orderable:!0,render:function(n,t,i){return`<input class='form-control' data-objid="`+i.purchasesDetailId+`" value='`+i.quantityItems+`' disabled >`}},{targets:6,data:"purpose",orderable:!1,autoWidth:!1},{targets:7,data:"dateTimeNeed",orderable:!1,autoWidth:!1,render:function(n){return moment(n).format("L")}},{targets:8,data:"note",orderable:!1,autoWidth:!1},{targets:9,data:null,visible:!1,orderable:!1,autoWidth:!1,render:function(){return`<a class="delete_row" href='javascript:void(0);'><i class="fal fa-trash-alt  align-bottom "></i></a>`}},],fnDrawCallback:function(){e++;h();c(e)}}),v=function(n){var t=$($(n).find("tbody tr td input"));$.each(t,function(n,t){$(t).removeAttr("disabled")})};$("#SynTable").on("click",".delete_row",function(){n.row($(this).parents("tr")).remove().draw()});$("#Save").click(function(){var e=$(this),t=[];n.data().each(function(n){f.push(n.purchasesDetailId);let i={};i.id=n.purchasesDetailId;i.quantity=n.quantityItems;t.push(i)});abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Lưu thay đổi"),app.localize("Bạn có chắc không"),function(o){var s;if(o){n.column(9).visible(!1);let o=u.filter(n=>!f.includes(n));for(console.log(o),s=0;s<o.length;s++)r.delete(o[s]).done(function(){i()});for(s=0;s<t.length;s++)r.updateQuantity({id:t[s].id,quantity:t[s].quantity}).done(function(){i()});e.hide();$("#Edit").show();$("#SendTo").removeAttr("disabled");abp.notify.info("Chỉnh sửa phiếu tổng hợp thành công!")}})});$("#SendTo").click(function(){var i=$(this);let n={};abp.libs.sweetAlert.config={confirm:{icon:"warning",buttons:["Không","Có"]}};abp.message.confirm(app.localize("Gửi phiếu yêu cầu tổng hợp"),app.localize("Bạn có chắc không"),function(r){r&&(n.purchasesRequestStatus=1,n.purchasesSynthesiseId=i[0].dataset.obj,n.email=$("#email").val(),n.link=window.location.href,n.name=$("#name").val(),t.updateStatus(n).done(function(){abp.notify.info("Gửi phiếu tổng hợp thành công!");i.hide();$("#Edit").hide();$("#Save").hide()}))})});$(".btn-browse").click(function(){var i=$(this);let n={};n.purchasesRequestStatus=2;n.purchasesSynthesiseId=i[0].dataset.quo;n.link=window.location.href;t.updateStatus(n).done(function(){abp.notify.info("Phê duyệt phiếu tổng hợp thành công!");$(".btn-browse").prop("hidden",!0);$(".btn-reject").prop("hidden",!0)})});$(".btn-reject").click(function(){var t=$(this),n;n={purchasesSynthesiseId:t[0].dataset.quo};n.link=window.location.href;s.open(n,function(){t.hide();$(".btn-browse").hide()})});abp.event.on("app.reloadDocTable",function(){i()});jQuery(document).ready(function(){$("#SearchTerm").focus()})}(jQuery);